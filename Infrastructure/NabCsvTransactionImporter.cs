using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Application;
using CsvHelper;
using Domain;

namespace Gilder.Infrastructure
{
    public class NabCsvTransactionImporter : ITransactionImporter
    {
        private const string NAB_CSV_STR = @"
Date,Charge,A,B,Classification,Details,Balance
04 Dec 21,0.00,,,EFTPOS DEBIT,POS 03/12 Uber                        Sydney,1081.78
04 Dec 21,-16.35,,,MISCELLANEOUS DEBIT,V7391 02/12 LIV*RAMEN DANBO SOUTH SOUTH BRISBAN,1081.78
04 Dec 21,-19.25,,,MISCELLANEOUS DEBIT,V7391 02/12 CALTEX STARMART HELENSVALE,1098.13
03 Dec 21,-45.25,,,EFTPOS DEBIT,POS 03/12 PANCAKE MANOR       BRISBANE CITY     AU,1117.38
03 Dec 21,-42.00,,,EFTPOS DEBIT,POS 03/12 SAVILE ROW                  FORTITUDE VA,1162.63
02 Dec 21,-59.99,,,MISCELLANEOUS DEBIT,V7391 01/12 TPG Internet PTY LTD     North Ryde 74564451335,1204.63
02 Dec 21,-98.10,,,EFTPOS DEBIT,EFTPOS 02/12 09:40  BURROW,1264.62
30 Nov 21,1064.15,,,INTER-BANK CREDIT,AIR PAY             AIR,1362.72
30 Nov 21,-31.40,,,MISCELLANEOUS DEBIT,V7391 30/11 PANCAKE MANOR            BRISBANE C 02060541855,298.57
30 Nov 21,-16.35,,,MISCELLANEOUS DEBIT,V7391 27/11 MCDONALDS REEDY CREEK    REEDY CREE 74564721333,329.97
30 Nov 21,-118.00,,,MISCELLANEOUS DEBIT,V7391 28/11 EZI*The Trustee for B-   Kelvin Gro 74155891332,346.32
30 Nov 21,-44.50,,,MISCELLANEOUS DEBIT,V7391 28/11 ARUNDEL TAVERN           ARUNDEL    07183194445,464.32
30 Nov 21,-35.50,,,MISCELLANEOUS DEBIT,V7391 27/11 KMART 1148               ROBINA     74363961331,508.82
30 Nov 21,-1.95,,,MISCELLANEOUS DEBIT,V7391 27/11 CALTEX STAR MART REEDY   BURLEIGH D 74940521332,544.32
30 Nov 21,-25.28,,,MISCELLANEOUS DEBIT,V7391 26/11 7-ELEVEN 4212 WORONG     CARRARA    74564451330,546.27
30 Nov 21,-25.00,,,MISCELLANEOUS DEBIT,V7391 26/11 MERLOT M GENTLEMEN       KELVIN GRO 74742721330,571.55
30 Nov 21,-250.00,,,TRANSFER DEBIT,INTERNET TRANSFER   27407642,596.55
29 Nov 21,-2.90,,,FEES,SML ATM    28th10:51TOEA PTY LTD         DIR CHG OTH ATM,846.55
29 Nov 21,-60.00,,,ATM DEBIT,SML ATM    28th10:51TOEA PTY LTD,849.45
29 Nov 21,-160.00,,,TRANSFER DEBIT,ONLINE  M9880765738 Food allowance      FEHR S,909.45
26 Nov 21,-19.60,,,MISCELLANEOUS DEBIT,V7391 26/11 COLES 4572               WORONGARY  74363961330,1069.45
26 Nov 21,-4.90,,,MISCELLANEOUS DEBIT,V7391 26/11 COLES 4572               WORONGARY  74363961330,1089.05
26 Nov 21,-30.23,,,MISCELLANEOUS DEBIT,V7391 25/11 DNH*GODADDY.COM AUSTRALIA480-505885 24906411329,1093.95
26 Nov 21,-10.95,,,EFTPOS DEBIT,EFTPOS 26/11 19:29  NOODLE BOX WORONGARY,1124.18
25 Nov 21,-15.99,,,MISCELLANEOUS DEBIT,V7391 24/11 NETFLIX.COM              Melbourne  74773881328,1135.13
24 Nov 21,-11.75,,,MISCELLANEOUS DEBIT,V7391 24/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241328,1151.12
24 Nov 21,-9.00,,,MISCELLANEOUS DEBIT,V7391 23/11 7-ELEVEN 4044            WEST END   74564451327,1162.87
24 Nov 21,-11.95,,,EFTPOS DEBIT,EFTPOS 24/11 15:36  Subway Kelvin Grove,1171.87
23 Nov 21,888.92,,,INTER-BANK CREDIT,AIR PAY             AIR,1183.82
23 Nov 21,-15.70,,,MISCELLANEOUS DEBIT,V7391 22/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241326,294.90
23 Nov 21,-5.50,,,MISCELLANEOUS DEBIT,V7391 21/11 COLES EXPRESS 1989       PARKWOOD   74363961325,310.60
23 Nov 21,-12.50,,,MISCELLANEOUS DEBIT,V7391 19/11 CROATIAN SPORT CENTRE    CARRARA    74940521324,316.10
23 Nov 21,-250.00,,,TRANSFER DEBIT,INTERNET TRANSFER   27407642,328.60
23 Nov 21,-46.00,,,EFTPOS DEBIT,EFTPOS 23/11 14:50  IZAKAYA GOKU,578.60
22 Nov 21,-123.50,,,TRANSFER DEBIT,Matthew Cabban      C9198575091         SEB,624.60
22 Nov 21,-160.00,,,TRANSFER DEBIT,ONLINE  G0393515212 Food allowance      FEHR S,748.10
22 Nov 21,-123.50,,,TRANSFER DEBIT,INTERNET TRANSFER   SEB,908.10
22 Nov 21,123.50,,,REVERSAL CREDIT,Matthew Cabban      C9198575091         SEB,1031.60
22 Nov 21,-24.64,,,EFTPOS DEBIT,EFTPOS 19/11 09:01  BP LOGANHOLME 8142,908.10
18 Nov 21,-24.40,000000000000,,MISCELLANEOUS DEBIT,V7391 18/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241322,1454.74
18 Nov 21,-418.00,000000000000,,MISCELLANEOUS DEBIT,V7391 17/11 DAVID JONES LIMITED CHERMSIDE 74940521321,932.74
18 Nov 21,-12.92,000000000000,,MISCELLANEOUS DEBIT,V7391 17/11 ME&U SURRY HILL 74611551321,1479.14
18 Nov 21,-104.00,000000000000,,MISCELLANEOUS DEBIT,V7391 16/11 WAGAYA JAPANESE REST FORTITUDE 02220784010,1350.74
16 Nov 21,-250.00,000000000000,,TRANSFER DEBIT,INTERNET TRANSFER 27407642,1492.06
16 Nov 21,-23.50,000000000000,,EFTPOS DEBIT,EFTPOS 16/11 12:45BURGER URGE Kelvin Grove AU,1934.87
16 Nov 21,1064.15,000000000000,,INTER-BANK CREDIT,AIR PAY AIR SEBASTIAAN FEHR,2016.83
16 Nov 21,-4.50,000000000000,,MISCELLANEOUS DEBIT,V7391 15/11 Kelvin Grove Tyres and KELVIN GRO 74564561319,2012.33
15 Nov 21,-160.00,000000000000,,TRANSFER DEBIT,ONLINE L4926956338 Food allowance FEHR S,952.68
16 Nov 21,-118.00,000000000000,,MISCELLANEOUS DEBIT,V7391 14/11 EZI*The Trustee for B- Kelvin Gro 74155891318,1742.06
16 Nov 21,-50.00,000000000000,,MISCELLANEOUS DEBIT,V7391 14/11 TIMEZONE COOLANGATT 74940521319,1860.06
16 Nov 21,-10.90,000000000000,,MISCELLANEOUS DEBIT,V7391 14/11 BASKIN-ROBBINS COOLA COOLANGATT 74564451319,1995.44
16 Nov 21,-24.81,000000000000,,MISCELLANEOUS DEBIT,V7391 13/11 ME&U SURRY HILL 74611551318,1910.06
16 Nov 21,-16.72,000000000000,,MISCELLANEOUS DEBIT,V7391 13/11 7 ELEVEN VIRGINIA 42 VIRGINIA 74564451318,1978.72
15 Nov 21,-22.00,000000000000,,EFTPOS DEBIT,EFTPOS 13/11 21:18HSW Events Brisbane AU,1112.68
15 Nov 21,-21.00,000000000000,,EFTPOS DEBIT,EFTPOS 13/11 01:36SQ *DEATH BEFORE DECNew Farm AU,1134.68
16 Nov 21,-20.35,000000000000,,MISCELLANEOUS DEBIT,V7391 12/11 MCDONALDS KANGAROO PT KANGAROO P 74564721319,1958.37
16 Nov 21,-5.99,000000000000,,MISCELLANEOUS DEBIT,V7391 12/11 Kelvin Grove Tyres and KELVIN GRO 74564561316,2006.34
12 Nov 21,-3.58,000000000000,,MISCELLANEOUS DEBIT,V7391 12/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241316,1197.22
12 Nov 21,-26.47,000000000000,,MISCELLANEOUS DEBIT,V7391 11/11 LINKT BRISBANE BRISBANE 74940521315,1155.68
12 Nov 21,-15.07,000000000000,,MISCELLANEOUS DEBIT,V7391 11/11 UBER *TRIP SYDNEY 74611551315,1182.15
11 Nov 21,-61.15,000000000000,,MISCELLANEOUS DEBIT,V7391 11/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241315,1301.25
11 Nov 21,-58.00,000000000000,,MISCELLANEOUS DEBIT,V7391 11/11 BWS/SHP 11 57 MUSK AVENUEKELVIN GRO 74278241315,1362.40
11 Nov 21,-100.45,000000000000,,MISCELLANEOUS DEBIT,V7391 10/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241314,1200.80
09 Nov 21,-250.00,000000000000,,TRANSFER DEBIT,INTERNET TRANSFER 27407642,1424.65
09 Nov 21,-33.12,000000000000,,MISCELLANEOUS DEBIT,V7391 09/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241313,1756.65
09 Nov 21,1064.15,000000000000,,INTER-BANK CREDIT,AIR PAY AIR SEBASTIAAN FEHR,1893.57
10 Nov 21,-4.25,000000000000,,MISCELLANEOUS DEBIT,V7391 08/11 RED ROSTER KELVIN GRO KELVIN GRO 74564721313,1420.40
09 Nov 21,-16.75,000000000000,,MISCELLANEOUS DEBIT,V7391 08/11 WOOLWORTHS/39 MUSK AVENUEKELVIN GRO 74278241312,1847.07
08 Nov 21,-160.00,000000000000,,TRANSFER DEBIT,ONLINE C9486417397 Food allowance FEHR S,829.42
08 Nov 21,-12.00,000000000000,,EFTPOS DEBIT,EFTPOS 08/11 12:37BURGER URGE Kelvin Grove AU,989.42
09 Nov 21,-27.80,000000000000,,MISCELLANEOUS DEBIT,V7391 07/11 KFC EVERTON PARK EVERTON PA 74564451312,1819.27
09 Nov 21,-82.00,000000000000,,MISCELLANEOUS DEBIT,V7391 06/11 Bulk Nutrients 6136266472 06060474788,1674.65
09 Nov 21,-29.50,000000000000,,MISCELLANEOUS DEBIT,V7391 06/11 Range Brewing Newstead 74249231310,1789.77
09 Nov 21,-9.00,000000000000,,MISCELLANEOUS DEBIT,V7391 06/11 Range Brewing Newstead 74249231310,1874.77
09 Nov 21,-3.00,000000000000,,MISCELLANEOUS DEBIT,V7391 06/11 NEW FARM BOWLS CLUB NEW FARM 74564721312,1890.57
09 Nov 21,-10.95,000000000000,,MISCELLANEOUS DEBIT,V7391 05/11 GM FOODS PTY LTD PADDINGTON 74564451310,1863.82
09 Nov 21,-6.80,000000000000,,MISCELLANEOUS DEBIT,V7391 05/11 BASKIN ROBINS PDNTON PADDINGTON 74564721312,1883.77
";
        
        public Task<IEnumerable<Transaction>> ImportTransactions()
        {
            // using var reader = new StreamReader($"{nameof(Transaction)}.csv");
            using var reader = new StringReader(NAB_CSV_STR);
            using var csv = new CsvReader(reader, CultureInfo.InvariantCulture);
            var records = csv.GetRecords<CsvTransaction>().ToList();

            var transactions = new List<Transaction>();
            foreach (var csvTransaction in records) {
                var date = DateTime.Parse(csvTransaction.Date);
                var charge = double.Parse(csvTransaction.Charge);
                var classification = ParseClassification(csvTransaction.Classification);
                var details = csvTransaction.Details;

                var transaction = new Transaction {
                    Charge = charge,
                    Date = date,
                    Class = classification,
                    Details = details
                };
                
                transactions.Add(transaction);
            }
            
            return Task.FromResult(transactions.AsEnumerable());
        }

        public async Task<Transaction> GetTransactionByHash(Hash transactionHash)
        {
            var transactions = await ImportTransactions();
            var transactionForHash = transactions
                .FirstOrDefault(t => t.ToHash().ToString() == transactionHash.ToString());

            return transactionForHash;
        }

        private Transaction.Classification ParseClassification(string transaction)
        {
            switch (transaction) {
                case "MISCELLANEOUS DEBIT": return Transaction.Classification.MiscDebit;
                case "EFTPOS DEBIT": return Transaction.Classification.EftposDebit;
                case "ATM DEBIT" : return Transaction.Classification.AtmDebit;
                case "INTER-BANK CREDIT" : return Transaction.Classification.InterBankCredit;
                case "TRANSFER DEBIT" : return Transaction.Classification.TransferDebit;
                case "FEES": return Transaction.Classification.Fees;
                case "REVERSAL CREDIT" : return Transaction.Classification.ReversalCredit;
                default: throw new FormatException($"{transaction} is not a know transaction type.");
            }
        }

        private class CsvTransaction
        {
            public string Date { get; set; }
            public string Charge { get; set; }
            public string Classification { get; set; }
            public string Details { get; set; }
        }
    }
}